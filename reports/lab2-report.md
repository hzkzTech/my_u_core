<center><font size=8 face="楷体">操作系统 Lab2 实验报告</font></center>

<center><font face="楷体">小组成员：</font></center>
<center><font face="楷体">1811398 鲁含章</font></center>
<center><font face="楷体">1811419 施君鉴</font></center>
<center><font face="楷体">1813670 左环语</font></center>

<center><font face="楷体">日期：2020年11月11日</font></center>


## 目录

[TOC]

## 练习2

#### 1. 关于控制寄存器CR0~3

他们具体的功能在做之初老搞不清楚，查阅记录如下

> **CR0**：包含了6个预定义标志，0位是保护允许位PE(Protedted Enable)，用于启动保护模式，如果PE位置1，则保护模式启动，如果PE=0，则在实模式下运行。1位是监控协处理位MP(Moniter coprocessor)，它与第3位一起决定：当TS=1时操作码WAIT是否产生一个“协处理器不能使用”的出错信号。第3位是任务转换位(Task Switch)，当一个任务转换完成之后，自动将它置1。随着TS=1，就不能使用协处理器。CR0的第2位是模拟协处理器位 EM (Emulate coprocessor)，如果EM=1，则不能使用协处理器，如果EM=0，则允许使用协处理器。第4位是微处理器的扩展类型位ET(Processor Extension Type)，其内保存着处理器扩展类型的信息，如果ET=0，则标识系统使用的是287协处理器，如果 ET=1，则表示系统使用的是387浮点协处理器。CR0的第31位是分页允许位(Paging Enable)，它表示芯片上的分页部件是否允许工作。

> **CR1**：未定义的控制寄存器，供将来的处理器使用。

> **CR2**：页故障线性地址寄存器，保存最后一次出现页故障的全32位线性地址。

> **CR3**：页目录基址寄存器，保存页目录表的物理地址，页目录表总是放在以4K字节为单位的存储器边界上，因此，它的地址的低12位总为0，不起作用，即使写上内容，也不会被理会。

#### 2. 关于u_core中的段式管理

开始看代码很疑惑变量va虚拟地址和la线性地址的区别，在80386里两者是不同的，而代码里似乎不是这样。翻阅指导书得到如下解答，所以u_core没有完整的段式管理。

>段式管理前一个实验已经讨论过。在 ucore 中段式管理只起到了一个过渡作用,它将逻辑地
>址不加转换直接映射成线性地址,所以我们在下面的讨论中可以对这两个地址不加区分(目
>前的 OS 实现也是不加区分的)。

#### 3. 如果ucore执行过程中访问内存,出现了页访问异常,请问硬件要做哪些事情?

这里问的是硬件，代码里就找不到了，查阅出现页访问异常会触发缺页中断,缺页中断发生时的事件顺序如下：

1. 硬件陷入内核,在内核堆栈中保存程序计数器。大多数机器将当前指令的各种状态信息保存在特殊的
   CPU寄存器中;
2. 启动一个汇编代码例程保存通用寄存器和其他易失的信息,以免被操作系统破坏;
3. 当操作系统发现一个缺页中断时,尝试发现需要哪个虚拟页面。通常一个硬件寄存器包含了这一信息,如果没有的话,操作系统必须检索程序计数器,取岀这条指令,用软件分析这条指令,看看它在缺页中断时正在做什么;
4. 一旦知道了发生缺页中断的虚拟地址,操作系统检査这个地址是否有效,并检査存取与保护是否一致如果不一致,向进程发岀一个信号或杀掉该进程。如果地址有效且没有保护错误发生,系统则检查是否有闲页框。如果没有空闲页框,执行页面置换算法寻找一个页面来淘汰;
5. 如果选择的页框“脏”了,安排该页写回磁盘,并发生一次上下文切换,挂起产生缺页中断的进程,让其他进程运行直至磁盘传输结東。无论如何,该页框被标记为忙,以免因为其他原因而被其他进程占用;
6. 一旦页框“干净”后(无论是立刻还是在写回磁盘后),操作系统查找所需页面在磁盘上的地址,通过磁盘操作将其装入。该页面被装入后,产生缺页中断的进程仍然被挂起,并且如果有其他可运行的用户进程则选择另一个用户进程运行；
7. 当磁盘中断发生时,表明该页已经被装入,页表已经更新可以反映它的位置,页框也被标记为正常状态；
8. 恢复发生缺页中断指令以前的状态,程序计数器重新指向这条指令；
9. 调度引发缺页中断的进程,操作系统返回调用它的汇编语言；
   1. 该例程恢复寄存器和其他状态信息。

## 练习3

练习3比较简单，就解答一下指导书里的问题：

#### 1. 数据结构Page的全局变量（其实是一个数组）的每一项与页表中的页目录项和页表项有无对应关系？如果有，其对应关系是啥？

- 是有存在对应关系：由于页表项中存放着对应的物理页的物理地址，因此可以通过这个物理地址来获取到对应到的Page数组的对应项，具体做法为将物理地址除以一个页的大小，然后乘上一个Page结构的大小获得偏移量，使用偏移量加上Page数组的基地址皆可以或得到对应Page项的地址； 

#### 2. 如果希望虚拟地址与物理地址相等，则需要如何修改lab2，完成此事？ 

- 我们只需将virt addr = linear addr = phy addr + 0xC0000000 转化改为virt addr = linear addr = phy addr + 0即使得虚拟地址与物理地址相等。

#### 3. 为什么将后12bit都置为0就可以获取到该pte中存储的物理页的地址值了呢？

- 这是因为存储在pte中到的物理地址页的后12bit其实都是为0的，因为我们存储的时候是根据一个页一个页去存储的，那么每个页的起始地址肯定是4096的整数倍，这样每个页的起始地址的后12bit肯定就是都为0的，因此就可以通过`& ~0xfff`的方法获取到一个pte中存储的物理地址页的起始地址

